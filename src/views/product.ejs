<!-- Products Management Section -->
<section id="products">
  <h2 class="mb-4 text-2xl font-bold">Quản lý sản phẩm</h2>
  <button
    onclick="showModal('addProductModal')"
    class="mb-4 rounded bg-green-500 py-2 px-4 font-bold text-white hover:bg-green-700"
  >
    Thêm sản phẩm mới
  </button>

  <!-- Filter Form, including search by name, filter by category, brand and sort by -->
  <form class="mb-4 text-sm">
    <div class="flex gap-4 items-center">
      <input
        class="focus:shadow-outline appearance-none rounded border py-2 px-3 leading-tight text-gray-700 shadow focus:outline-none"
        type="text"
        placeholder="Tìm kiếm theo tên"
      />
      <select
        id="category"
        class="focus:shadow-outline appearance-none rounded border py-2 px-3 leading-tight text-gray-700 shadow focus:outline-none"
      >
        <option value="default">Loại</option>
        <% categories.forEach((category) => { %>
          <option value="<%= category.name %>"><%= category.name %></option>
        <% }); %>
      </select>
      <select
        id="brand"
        class="focus:shadow-outline appearance-none rounded border py-2 px-3 leading-tight text-gray-700 shadow focus:outline-none"
      >
        <option value="default">Thương hiệu</option>
        <% brands.forEach((brand) => { %>
          <option value="<%= brand.name %>"><%= brand.name %></option>
        <% }); %>
      </select>

      <button type="button" id="filter-button" class="rounded bg-blue-500 py-2 px-4 font-bold text-white hover:bg-blue-700 focus:outline-none">
        Lọc
      </button>

      <p class="flex-1 text-end">Sắp xếp: </p>
      <select
        id="sort"
        class="focus:shadow-outline appearance-none rounded border py-2 px-3 leading-tight text-gray-700 shadow focus:outline-none"
      >
        <option value="default">Mặc định</option>
        <option value="create_time-desc">Ngày tạo: Mới nhất</option>
        <option value="create_time-asc">Ngày tạo: Cũ nhất</option>
        <option value="price_sale-asc">Giá: tăng dần</option>
        <option value="price_sale-desc">Giá: giảm dần</option>
        <option value="sales-asc">Doanh số: tăng dần</option>
        <option value="sales-desc">Doanh số: giảm dần</option>
      </select>
    </div>
  </form>

  <!-- Product Table -->
  <table class="min-w-full bg-white">
    <thead>
      <tr class="text-sm">
        <th class="border-b p-2 px-4">ID</th>
        <th class="border-b p-2">Sản phẩm</th>
        <th class="border-b p-2">Giá</th>
        <th class="border-b p-2">Loại</th>
        <th class="border-b p-2">Thương hiệu</th>
        <th class="border-b p-2">Ngày tạo</th>
        <th class="border-b p-2">Tồn kho</th>
        <th class="border-b p-2">Tình trạng</th>
        <th class="border-b p-2">Doanh số</th>
      </tr>
    </thead>
    <tbody id="productTableBody">
      <!-- Product rows will be dynamically added here -->
      <% data.products.forEach((product) => { %>
      <tr class="text-sm">
        <td class="p-2 px-4 border-b text-center"><%= product.id %></td>
        <td class="flex p-2 border-b items-center">
          <img class="h-16 w-16 object-cover mr-2" src="<%= product.profile_img %>" alt="<%= product.name %>">
          <p><%= product.name %></p>
        </td>
        <td class="p-2 border-b text-center">
          <% if (product.price_sale === product.price) { %>
            <%= new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND' }).format(product.price) %>
          <% } else { %>
            <span class="line-through text-gray-500"><%= new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND' }).format(product.price) %></span>
            <span class="text-red-500"><%= new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND' }).format(product.price_sale) %></span>
          <% } %>
        </td>
        <td class="p-2 border-b text-center"><%= product.category %></td>
        <td class="p-2 border-b text-center"><%= product.brand %></td>
        <td class="border-b text-center"><%= product.create_time.toLocaleString() %></td>
        <td class="p-2 border-b text-center"><%= product.in_stock %></td>
        <td class="p-2 border-b text-center">
          <% if (product.status === 'on stock') { %>
            <span class="text-green-500">Còn hàng</span>
          <% } else if (product.status === 'out of stock') { %>
            <span class="text-red-500">Hết hàng</span>
          <% } else { %>
            <span class="text-yellow-500">Ngừng kinh doanh</span>
          <% } %>
        </td>
        <td class="p-2 border-b text-center"><%= product.sales %></td>
      </tr>
      <% }); %>
    </tbody>
  </table>

  <!-- Product paging (include at most 5 numbers at once) -->
  <div class="flex justify-center gap-2 mt-5 text-sm">
    <button class="rounded border bg-blue-500 py-2 px-4 text-white hover:bg-blue-700 focus:outline-none">
      1
    </button>
    <button class="rounded border border-blue-500 text-blue-500 py-2 px-4 hover:bg-blue-700 focus:outline-none">
      2
    </button>
    <button class="rounded border border-blue-500 text-blue-500 py-2 px-4 hover:bg-blue-700 focus:outline-none">
      3
    </button>
    <button class="rounded border border-blue-500 text-blue-500 py-2 px-4 hover:bg-blue-700 focus:outline-none">
      4
    </button>
    <button class="rounded border border-blue-500 text-blue-500 py-2 px-4 hover:bg-blue-700 focus:outline-none">
      5
    </button>
    <button class="rounded border bg-blue-500 py-2 px-4 text-white hover:bg-blue-700 focus:outline-none">
      Trang sau
    </button>
  </div>
</section>


<!-- Add Product Modal -->
<div
  id="addProductModal"
  class="fixed inset-0 hidden h-full w-full overflow-y-auto bg-gray-600 bg-opacity-50"
>
  <div
    class="relative top-20 mx-auto w-96 rounded-md border bg-white p-5 shadow-lg"
  >
    <h3 class="mb-4 text-lg font-bold">Add New Product</h3>
    <form id="addProductForm">
      <div class="mb-4">
        <label class="mb-2 block text-sm font-bold text-gray-700" for="name">
          Name
        </label>
        <input
          class="focus:shadow-outline w-full appearance-none rounded border py-2 px-3 leading-tight text-gray-700 shadow focus:outline-none"
          id="name"
          type="text"
          placeholder="Name"
          required
        />
      </div>
      <div class="mb-4">
        <label class="mb-2 block text-sm font-bold text-gray-700" for="brand">
          Brand
        </label>
        <input
          class="focus:shadow-outline w-full appearance-none rounded border py-2 px-3 leading-tight text-gray-700 shadow focus:outline-none"
          id="brand"
          type="text"
          placeholder="Brand"
          required
        />
      </div>
      <div class="mb-4">
        <label
          class="mb-2 block text-sm font-bold text-gray-700"
          for="category"
        >
          Category
        </label>
        <input
          class="focus:shadow-outline w-full appearance-none rounded border py-2 px-3 leading-tight text-gray-700 shadow focus:outline-none"
          id="category"
          type="text"
          placeholder="Category"
          required
        />
      </div>
      <div class="mb-4">
        <label class="mb-2 block text-sm font-bold text-gray-700" for="storage">
          Storage
        </label>
        <input
          class="focus:shadow-outline w-full appearance-none rounded border py-2 px-3 leading-tight text-gray-700 shadow focus:outline-none"
          id="storage"
          type="text"
          placeholder="Storage"
        />
      </div>
      <div class="mb-4">
        <label class="mb-2 block text-sm font-bold text-gray-700" for="cpu">
          CPU
        </label>
        <input
          class="focus:shadow-outline w-full appearance-none rounded border py-2 px-3 leading-tight text-gray-700 shadow focus:outline-none"
          id="cpu"
          type="text"
          placeholder="CPU"
        />
      </div>
      <div class="mb-4">
        <label
          class="mb-2 block text-sm font-bold text-gray-700"
          for="screenSize"
        >
          Screen Size
        </label>
        <input
          class="focus:shadow-outline w-full appearance-none rounded border py-2 px-3 leading-tight text-gray-700 shadow focus:outline-none"
          id="screenSize"
          type="text"
          placeholder="Screen Size"
        />
      </div>
      <div class="mb-4">
        <label
          class="mb-2 block text-sm font-bold text-gray-700"
          for="resolution"
        >
          Resolution
        </label>
        <input
          class="focus:shadow-outline w-full appearance-none rounded border py-2 px-3 leading-tight text-gray-700 shadow focus:outline-none"
          id="resolution"
          type="text"
          placeholder="Resolution"
        />
      </div>
      <div class="mb-4">
        <label class="mb-2 block text-sm font-bold text-gray-700" for="ram">
          Ram
        </label>
        <input
          class="focus:shadow-outline w-full appearance-none rounded border py-2 px-3 leading-tight text-gray-700 shadow focus:outline-none"
          id="ram"
          type="text"
          placeholder="Ram"
        />
      </div>
      <div class="mb-4">
        <label
          class="mb-2 block text-sm font-bold text-gray-700"
          for="graphicCard"
        >
          Graphic Card
        </label>
        <input
          class="focus:shadow-outline w-full appearance-none rounded border py-2 px-3 leading-tight text-gray-700 shadow focus:outline-none"
          id="graphicCard"
          type="text"
          placeholder="Graphic Card"
        />
      </div>
      <div class="mb-4">
        <label
          class="mb-2 block text-sm font-bold text-gray-700"
          for="description"
        >
          Description
        </label>
        <input
          class="focus:shadow-outline w-full appearance-none rounded border py-2 px-3 leading-tight text-gray-700 shadow focus:outline-none"
          id="description"
          type="text"
          placeholder="Description"
        />
      </div>
      <div class="mb-4">
        <label class="mb-2 block text-sm font-bold text-gray-700" for="images">
          Images
        </label>
        <input
          class="focus:shadow-outline w-full appearance-none rounded border py-2 px-3 leading-tight text-gray-700 shadow focus:outline-none"
          id="images"
          type="file"
          multiple
          accept="image/*"
        />
        <div id="imagesPreview" class="flex flex-wrap mt-2">
          <!-- Preview images will be appended here -->
        </div>
      </div>
      <div class="mb-4">
        <label class="mb-2 block text-sm font-bold text-gray-700" for="price">
          Price
        </label>
        <input
          class="focus:shadow-outline w-full appearance-none rounded border py-2 px-3 leading-tight text-gray-700 shadow focus:outline-none"
          id="price"
          type="number"
          min="0"
          placeholder="Price"
          required
        />
      </div>
      <div class="mb-4">
        <label
          class="mb-2 block text-sm font-bold text-gray-700"
          for="priceSale"
        >
          Price Sale
        </label>
        <input
          class="focus:shadow-outline w-full appearance-none rounded border py-2 px-3 leading-tight text-gray-700 shadow focus:outline-none"
          id="priceSale"
          type="number"
          min="0"
          placeholder="Price Sale"
        />
      </div>
      <div class="mb-4">
        <label class="mb-2 block text-sm font-bold text-gray-700" for="inStock">
          In Stock
        </label>
        <input
          class="focus:shadow-outline w-full appearance-none rounded border py-2 px-3 leading-tight text-gray-700 shadow focus:outline-none"
          id="inStock"
          type="number"
          min="0"
          placeholder="In Stock"
        />
      </div>
      <div class="mb-4">
        <label class="mb-2 block text-sm font-bold text-gray-700" for="status">
          Status
        </label>
        <select
          class="focus:shadow-outline w-full appearance-none rounded border py-2 px-3 leading-tight text-gray-700 shadow focus:outline-none"
          id="status"
        >
          <option value="on stock">On Stock</option>
          <option value="out of stock">Out of Stock</option>
          <option value="suspend">Suspend</option>
        </select>
      </div>
      <div class="flex items-center justify-between">
        <button
          class="focus:shadow-outline rounded bg-blue-500 py-2 px-4 font-bold text-white hover:bg-blue-700 focus:outline-none"
          type="submit"
        >
          Add Product
        </button>
        <button
          class="focus:shadow-outline rounded bg-gray-500 py-2 px-4 font-bold text-white hover:bg-gray-700 focus:outline-none"
          type="button"
          onclick="hideModal('addProductModal')"
        >
          Cancel
        </button>
      </div>
    </form>
  </div>
</div>
<script>
  // Use this for AJAX rendering
  function renderProducts(products) {
    const tableBody = document.getElementById('productTableBody');
    tableBody.innerHTML = '';
    products.forEach((product) => {
      const row = `
                    <tr class="text-sm">
                      <td class="p-2 px-4 border-b text-center">${product.id}</td>
                      <td class="flex p-2 border-b items-center">
                        <img class="h-16 w-16 object-cover mr-2" src="${product.profile_img}" alt="${product.name}">
                        <p>${product.name}</p>
                      </td>
                      <td class="p-2 border-b text-center">
                        ${(product.price_sale === product.price) ?
                            new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND' }).format(product.price)
                            : `<span class="line-through text-gray-500">${new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND' }).format(product.price)}</span>
                               <span class="text-red-500">${new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND' }).format(product.price_sale)}</span>`}
                      </td>
                      <td class="p-2 border-b text-center">${product.category}</td>
                      <td class="p-2 border-b text-center">${product.brand}</td>
                      <td class="border-b text-center">${product.create_time.toLocaleString()}</td>
                      <td class="p-2 border-b text-center">${product.in_stock}</td>
                      <td class="p-2 border-b text-center">
                        ${ product.status === 'on stock' ? `<span class="text-green-500">Còn hàng</span>`
                          : product.status === 'out of stock' ? `<span class="text-red-500">Hết hàng</span>`
                          : `<span class="text-yellow-500">Ngừng kinh doanh</span>` }
                      </td>
                      <td class="p-2 border-b text-center">${product.sales}</td>
                    </tr>
                `;
      tableBody.innerHTML += row;
    });
  }

  let selectedImages = [];

  document
    .getElementById('images')
    .addEventListener('change', function (event) {
      [...event.target.files].forEach((file) => selectedImages.push(file));
      renderSelectedImages();
    });

  function renderSelectedImages() {
    const previewContainer = document.getElementById('imagesPreview');
    previewContainer.innerHTML = '';

    selectedImages.forEach((file, index) => {
      const reader = new FileReader();
      reader.onload = (e) => {
        const wrapper = document.createElement('div');
        wrapper.classList.add('relative', 'inline-block', 'm-1');

        const img = document.createElement('img');
        img.src = e.target.result;
        img.classList.add('h-20', 'w-20', 'object-cover');

        const removeBtn = document.createElement('button');
        removeBtn.type = 'button';
        removeBtn.innerText = 'x';
        removeBtn.classList.add(
          'absolute',
          '-top-2',
          '-right-2',
          'bg-red-600',
          'text-white',
          'rounded-full',
          'w-4',
          'h-4',
          'flex',
          'items-center',
          'justify-center',
          'text-sm',
          'font-bold',
          'hover:bg-red-700',
          'focus:outline-none',
        );
        removeBtn.onclick = () => removeImage(index);

        wrapper.appendChild(img);
        wrapper.appendChild(removeBtn);
        previewContainer.appendChild(wrapper);
      };
      reader.readAsDataURL(file);
    });
  }

  function removeImage(index) {
    selectedImages.splice(index, 1);
    renderSelectedImages();
  }

  async function addProduct(event) {
    event.preventDefault();
    const formData = new FormData();
    selectedImages.forEach((file) => formData.append('images', file));
    formData.append('name', document.getElementById('name').value);
    formData.append('brand', document.getElementById('brand').value);
    formData.append('category', document.getElementById('category').value);
    formData.append('storage', document.getElementById('storage').value);
    formData.append('cpu', document.getElementById('cpu').value);
    formData.append('screenSize', document.getElementById('screenSize').value);
    formData.append('resolution', document.getElementById('resolution').value);
    formData.append('ram', document.getElementById('ram').value);
    formData.append(
      'graphicCard',
      document.getElementById('graphicCard').value,
    );
    formData.append(
      'description',
      document.getElementById('description').value,
    );
    formData.append('price', document.getElementById('price').value);
    formData.append('priceSale', document.getElementById('priceSale').value);
    formData.append('inStock', document.getElementById('inStock').value);
    formData.append('status', document.getElementById('status').value);

    await fetch('/api/product', {
      method: 'POST',
      body: formData,
    })
      .then((res) => res.json())
      .then((data) => {
        if (data.success) {
          // SweetAlert2
          Swal.fire({
            icon: 'success',
            title: 'Sản phẩm đã được thêm thành công',
            timer: 2000,
            timerProgressBar: true,
            showConfirmButton: false,
          });
        } else {
          // SweetAlert2
          Swal.fire({
            icon: 'error',
            title: 'Thêm sản phẩm thất bại',
            text: data.message,
            timer: 2000,
            timerProgressBar: true,
            showConfirmButton: false,
          });
        }
      });
    // renderProducts();
    hideModal('addProductModal');
    event.target.reset();
    selectedImages = [];
    renderSelectedImages();
  }

  function editProduct(id) {
    // Implement edit functionality
    console.log('Edit product', id);
  }

  function deleteProduct(id) {
    products = products.filter((product) => product.id !== id);
    renderProducts();
  }

  // Event listeners
  document
    .getElementById('addProductForm')
    .addEventListener('submit', addProduct);

  async function fetchFilterProducts() {
    const category = document.getElementById('category').value;
    const brand = document.getElementById('brand').value;
    const sort = document.getElementById('sort').value;

    // Build query string
    let queryString = new URLSearchParams();

    if (category && category !== 'default') queryString.append('category', category);
    if (brand && brand !== 'default') queryString.append('brand', brand);
    if (sort && sort !== 'default') {
      const [field, order] = sort.split('-');
      queryString.append('sortBy', field);
      queryString.append('order', order);
    }

    const res = await fetch(`/api/product?${queryString.toString()}`);
    const data = await res.json();
    renderProducts(data.products);
  }

  // Event listener for filter button
  document.getElementById('filter-button').addEventListener('click', fetchFilterProducts);

  // Event listener for sorting
  document.getElementById('sort').addEventListener('change', fetchFilterProducts);

</script>
